<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ç¥çµŒè¡°å¼± Ultimate AI v1.0</title>

<style>
:root{ --cardSize:90px; }

body{
margin:0;
font-family:Arial, sans-serif;
background:#030712;
color:#9ffcff;
overflow:hidden;
}

/* ===== ç”»é¢ ===== */
.screen{
position:absolute;
width:100%;
height:100%;
display:flex;
flex-direction:column;
justify-content:center;
align-items:center;
animation:fade .4s;
padding:10px;
box-sizing:border-box;
}
.hidden{display:none;}
@keyframes fade{from{opacity:0}to{opacity:1}}

/* ===== é™å‚ ===== */
.surrender{
position:absolute;
top:15px;
right:15px;
padding:10px 16px;
background:#ff3b3b;
border:none;
border-radius:10px;
color:white;
cursor:pointer;
font-size:14px;
}

/* ===== ãƒ‘ãƒãƒ« ===== */
.panel{
background:#081c2b;
padding:20px 30px;
border-radius:15px;
box-shadow:0 0 20px #00eaff55;
text-align:center;
}

button,select{
margin:8px;
padding:10px 15px;
font-size:16px;
border:none;
border-radius:8px;
background:#0090ff;
color:white;
cursor:pointer;
}

/* ===== ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ ===== */
.startRow{
display:flex;
flex-direction:row;
justify-content:center;
align-items:center;
gap:20px;
margin-bottom:20px;
}
.startRow select{
min-width:120px;
}

/* ===== ç›¤é¢ ===== */
.board{
display:grid;
gap:10px;
margin-top:15px;
justify-content:center;
}

/* ===== ã‚«ãƒ¼ãƒ‰ ===== */
.card{
width:var(--cardSize);
height:calc(var(--cardSize)*1.2);
border-radius:12px;
background:#002b5c;
display:flex;
justify-content:center;
align-items:center;
font-size:calc(var(--cardSize)*0.45);
cursor:pointer;
transition:transform .3s, background .3s, box-shadow .3s;
box-shadow:0 0 15px #00eaff88 inset;
transform:translateZ(0);
}

.card.open{
background:#001d3d;
transform:scale(1.1);
box-shadow:0 0 25px #00eaff;
}

.card.matched{
background:#00ff9c;
color:black;
animation:matchedEffect .6s;
}

@keyframes matchedEffect{
0%{box-shadow:0 0 15px #00eaff88 inset;}
50%{box-shadow:0 0 40px #00ff9c, 0 0 50px #00ff9c;}
100%{box-shadow:0 0 25px #00ff9c;}
}

/* ===== ã‚·ã‚§ã‚¤ã‚¯ ===== */
.shakeWrap{
will-change:transform;
animation:shake .35s ease;
animation-fill-mode:both;
}

@keyframes shake{
25%{transform:translate3d(-6px,4px,0)}
50%{transform:translate3d(6px,-4px,0)}
75%{transform:translate3d(-4px,3px,0)}
100%{transform:translate3d(0,0,0)}
}

/* ===== AIæ€è€ƒ ===== */
.thinking{font-size:22px;opacity:.8;height:28px;margin:10px;}
.dots::after{content:"";animation:dots 1.2s infinite;}
@keyframes dots{0%{content:""}33%{content:"."}66%{content:".."}100%{content:"..."}}

.timer{font-size:22px;}
.result{font-size:70px;}
.win{color:gold; animation:winEffect 1s;}
.lose{color:red; animation:loseEffect 1s;}
.draw{color:silver; animation:drawEffect 1s;}

@keyframes winEffect{0%{transform:scale(0.7);}50%{transform:scale(1.2);}100%{transform:scale(1);}}
@keyframes loseEffect{0%{transform:scale(1.2);}50%{transform:scale(0.8);}100%{transform:scale(1);}}
@keyframes drawEffect{0%{transform:scale(0.8);}50%{transform:scale(1.1);}100%{transform:scale(1);}}
</style>
</head>

<body>

<!-- ã‚¹ã‚¿ãƒ¼ãƒˆ -->
<div id="startScreen" class="screen">
<div class="panel">
<h1>ç¥çµŒè¡°å¼±</h1>

<div class="startRow">
<div>
<label>ã‚«ãƒ¼ãƒ‰æ•°</label><br>
<select id="size">
<option value="12" selected>4Ã—3</option>
<option value="16">4Ã—4</option>
<option value="24">6Ã—4</option>
</select>
</div>

<div>
<label>AIãƒ¬ãƒ™ãƒ«</label><br>
<select id="level">
<option value="low">ä½</option>
<option value="mid">ä¸­</option>
<option value="high">é«˜</option>
<option value="max">æœ€é«˜</option>
<option value="pro">ãƒ—ãƒ­</option>
<option value="god">ä¸–ç•Œæœ€å¼·AI</option>
</select>
</div>
</div>

<button onclick="confirmStart()" style="margin-top:10px;">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
</div>
</div>

<!-- ã‚²ãƒ¼ãƒ  -->
<div id="gameScreen" class="screen hidden">
<button class="surrender" onclick="surrender()">é™å‚</button>
<div id="info" style="font-size:22px;"></div>
<div id="timer" class="timer"></div>
<div id="thinking" class="thinking"></div>

<div id="shakeWrap">
<div id="board" class="board"></div>
</div>
</div>

<!-- çµæœ -->
<div id="resultScreen" class="screen hidden">
<div id="resultText" class="result"></div>
<button onclick="location.reload()">OK</button>
</div>

<script>
const icons=["ğŸ","ğŸŒ","ğŸ‡","ğŸ“","ğŸ’","ğŸ¥","ğŸ","ğŸ¥‘","ğŸ‰","ğŸ¥¥","ğŸ‹","ğŸŠ"];

let cards=[],opened=[],matched=0;
let player=0,npc=0,turn="player";
let memory={},level="low";
let timer=20,timerID;

const sizeSel=document.getElementById("size");
const levelSel=document.getElementById("level");
const info=document.getElementById("info");
const timerText=document.getElementById("timer");
const thinking=document.getElementById("thinking");
const gameScreen=document.getElementById("gameScreen");
const resultScreen=document.getElementById("resultScreen");
const resultText=document.getElementById("resultText");

/* ===== è¨­å®šä¿å­˜ ===== */
sizeSel.value=localStorage.getItem("cardSize")||"12";
levelSel.value=localStorage.getItem("npcLevel")||"low";
sizeSel.onchange=()=>localStorage.setItem("cardSize",sizeSel.value);
levelSel.onchange=()=>localStorage.setItem("npcLevel",levelSel.value);

/* ===== é™å‚ ===== */
function surrender(){
if(confirm("æœ¬å½“ã«é™å‚ã—ã¾ã™ã‹ï¼Ÿ")){
npc=999;
endGame();
}
}

/* ===== ã‚¹ã‚¿ãƒ¼ãƒˆç¢ºèª ===== */
function confirmStart(){
if(levelSel.value==="god"){
if(!confirm("å‹ã¦ã‚‹ç¢ºç‡ã¯100%ä¸­30%ã§ã™ãŒã‚¹ã‚¿ãƒ¼ãƒˆã—ã¾ã™ã‹ï¼Ÿ")) return;
}
startGame();
}

/* ===== é–‹å§‹ ===== */
function startGame(){
document.getElementById("startScreen").classList.add("hidden");
gameScreen.classList.remove("hidden");

level=levelSel.value;
const size=parseInt(sizeSel.value);

const board=document.getElementById("board");
board.innerHTML="";

/* åˆ—æ•° */
let cols = (size===12 || size===16) ? 4 : 6;

/* ã‚¹ãƒãƒ›å¯¾å¿œã‚«ãƒ¼ãƒ‰ã‚µã‚¤ã‚º */
const root=document.documentElement;
let availableWidth=window.innerWidth-40;
let cardSize=Math.min(90,Math.floor(availableWidth/cols)-10);
root.style.setProperty("--cardSize",cardSize+"px");
board.style.gridTemplateColumns=`repeat(${cols}, var(--cardSize))`;

/* ã‚«ãƒ¼ãƒ‰ç”Ÿæˆ */
let arr=[];
for(let i=0;i<size/2;i++) arr.push(icons[i],icons[i]);
arr.sort(()=>Math.random()-0.5);

cards=arr;
opened=[];
matched=0;
player=0;
npc=0;
memory={};

/* æœ€é«˜ãƒ»ãƒ—ãƒ­ãƒ»ä¸–ç•Œæœ€å¼·ã¯å…ˆæ‰‹ãƒ©ãƒ³ãƒ€ãƒ  */
turn="player";
if(level==="max" || level==="pro" || level==="god"){
turn=Math.random()<0.5?"player":"npc";
}

/* ã‚«ãƒ¼ãƒ‰ä½œæˆ */
arr.forEach((v,i)=>{
const c=document.createElement("div");
c.className="card";
c.dataset.i=i;
c.onclick=()=>playerTurn(c);
board.appendChild(c);
});

updateInfo();
startTimer();

if(turn==="npc") npcThink();
}

/* ===== ã‚¿ã‚¤ãƒãƒ¼ ===== */
function startTimer(){
clearInterval(timerID);
timer=20;
timerText.textContent="æ®‹ã‚Š "+timer;
timerID=setInterval(()=>{
timer--;
timerText.textContent="æ®‹ã‚Š "+timer;
if(timer<=0) timeout();
},1000);
}

function timeout(){ closeOpened(); switchTurn(); }

/* ===== UI ===== */
function updateInfo(){
info.textContent=`ã‚ãªãŸ ${player} - NPC ${npc} ï½œ ${turn==="player"?"ã‚ãªãŸã®ç•ª":"AIã®ç•ª"}`;
}

/* ===== ã‚¿ãƒ¼ãƒ³ ===== */
function switchTurn(){
turn=turn==="player"?"npc":"player";
updateInfo();
startTimer();
if(turn==="npc") npcThink();
}

/* ===== AIæ€è€ƒ ===== */
function rand(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }

function getThinkingDelay(){
if(level==="low") return rand(400,800);
if(level==="mid") return rand(600,1100);
if(level==="high") return rand(900,1500);
if(level==="max" || level==="pro") return rand(1000,5000);
if(level==="god") return 500;
return 800;
}

function npcThink(){
thinking.innerHTML='AIæ€è€ƒä¸­<span class="dots"></span>';
const delay=getThinkingDelay();
setTimeout(()=>{
thinking.textContent="";
npcTurn();
},delay);
}

/* ===== ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ ===== */
function playerTurn(card){
if(turn!=="player") return;
openCard(card);
}

/* ===== ã‚«ãƒ¼ãƒ‰é–‹ã ===== */
function openCard(card){
if(!card) return;
if(card.classList.contains("open")||card.classList.contains("matched")) return;
if(opened.length===2) return;

const i=card.dataset.i;
card.textContent=cards[i];
card.classList.add("open");
remember(i);
opened.push(card);

if(opened.length===2) setTimeout(checkPair,600);
}

/* ===== è¨˜æ†¶ ===== */
function remember(i){
const v=cards[i];
if(!memory[v]) memory[v]=[];
if(!memory[v].includes(i)) memory[v].push(i);
}

/* ===== åˆ¤å®š ===== */
function checkPair(){
const [a,b]=opened;
if(a.textContent===b.textContent){
a.classList.add("matched");
b.classList.add("matched");
if(turn==="player") player++;
else npc++;
matched+=2;
opened=[];
updateInfo();
if(matched===cards.length) return endGame();
if(turn==="npc") npcThink();
else startTimer();
}else{
shakeBoard();
closeOpened();
switchTurn();
}
}

function closeOpened(){
opened.forEach(c=>{c.classList.remove("open");c.textContent=""});
opened=[];
}

/* ===== ã‚·ã‚§ã‚¤ã‚¯ ===== */
function shakeBoard(){
const wrap=document.getElementById("shakeWrap");
wrap.classList.remove("shakeWrap");
void wrap.offsetWidth;
wrap.classList.add("shakeWrap");
}

/* ===== NPC AI ===== */
function npcTurn(){
if(turn!=="npc") return;
let first=null,second=null;
let prob;
if(level==="god") prob=1; // ä¸–ç•Œæœ€å¼·ã¯100%å½“ã¦ã‚‹
else prob={low:0.2,mid:0.5,high:0.75,max:0.95,pro:1}[level];

if(Math.random()<prob){[first,second]=findPerfectMove();}
if(first===null){first=randomCard();second=randomCard(first);}
openCard(getCard(first));
setTimeout(()=>{if(turn!=="npc") return;openCard(getCard(second));},600);
}

function findPerfectMove(){
for(let v in memory){
const arr=memory[v].filter(i=>!isMatched(i));
if(arr.length>=2) return [arr[0],arr[1]];
}
return [null,null];
}

function randomCard(exclude=null){
let free=[];
document.querySelectorAll(".card:not(.matched)").forEach(c=>{
const i=parseInt(c.dataset.i);
if(i!==exclude) free.push(i);
});
if(free.length===0) return null;
return free[Math.floor(Math.random()*free.length)];
}

function isMatched(i){ return getCard(i).classList.contains("matched"); }
function getCard(i){ return document.querySelector(`[data-i="${i}"]`); }

/* ===== çµ‚äº† ===== */
function endGame(){
clearInterval(timerID);
gameScreen.classList.add("hidden");
resultScreen.classList.remove("hidden");

if(player>npc){ resultText.textContent="å‹ã¡"; resultText.className="result win"; }
else if(player<npc){ resultText.textContent="è² ã‘"; resultText.className="result lose"; }
else{ resultText.textContent="å¼•ãåˆ†ã‘"; resultText.className="result draw"; }
}
</script>
</body>
</html>
